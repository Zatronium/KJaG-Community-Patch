require 'scripts/avatars/common'

local kaiju = nil;
local Angle = 55;
local weapon = "weapon_shrubby_poisonSpray1"
local number_of_ticks = 5;

function onUse(a)
	kaiju = a;
	playAnimation(a, "ability_breath");
	registerAnimationCallback(this, a, "start");
end

function onAnimationEvent(a)
	startCooldown(a, abilityData.name);
	playSound("shrubby_ability_PoisonPlume");
	local view = a:getView();
	local worldPosition = a:getWorldPosition();
	local worldFacing = a:getWorldFacing();
	local sceneFacing = a:getSceneFacing();
	
	local targets = getTargetsInCone(worldPosition, 400, Angle, worldFacing, EntityFlags(EntityType.Vehicle));
	view:doEffectFromNode('breath_node', 'effects/poisonPlume_core.plist', sceneFacing);
	view:doEffectFromNode('breath_node', 'effects/poisonPlume_range.plist', sceneFacing);
	view:doEffectFromNode('breath_node', 'effects/poisonPlume_center.plist', sceneFacing);
	view:doEffectFromNode('breath_node', 'effects/poisonPlume_main.plist', sceneFacing);
	view:doEffectFromNode('breath_node', 'effects/poisonPlume_muzzle.plist', sceneFacing);
	for t in targets:iterator() do
		if canTarget(t) and isOrganic(t) then

			t:attachEffect("effects/poisonPlume_aura.plist", 2, true);

			local aura = createAura(this, t, 0);
			aura:setTickParameters(1, 0);
			aura:setScriptCallback(AuraEvent.OnTick, "onTick");
			aura:setTarget(t);
			t = nil; -- onTick may have killed target at this point

		end
	end
end

function onTick(aura)
	if not aura then return end
	if aura:getElapsed() >= number_of_ticks then
		
		local self = aura:getOwner()
		if not self then
			aura = nil return;
		else
			self:detachAura(aura);
		end
	else
		applyDamageWithWeapon(kaiju, aura:getTarget(), weapon);
	end
end